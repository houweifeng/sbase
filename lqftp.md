异步可靠文件传输系统

概述
目前一般的传输工具都具备单个或者批量文件传输的功能,但是对于文件传输过程中如果出错只能退出,需要人为或者脚本干预才能继续传输.本文设计的传输系统把每个需要传输的文件任务化和队列化,即使在网络中断,机器重启后仍然能继续顺序传输,保证每个进入任务表的文件可靠无误的传输到指定机器的指定目录下. 该系统对于任务提交者来讲为异步传输,也就是任务提交者只要提交完任务不需要等待任务完成,而是得到一个任务号,通过这个任务号随时可以查询该任务状态. 该系统主要分为3大部分:接收端服务程序,传输服务程序,任务提交程序.

任务提交程序
主要负责提交任务给本地传输服务,可以单个提交也可以通过文件进行批量提交,还可以当作监控程序监控制定目录下的文件异动,发现标示文件后会立即将文件提交到本地传输服务.

数据传输服务程序
传输服务程序监听端口, 负责接受任务提交,任务编号,任务执行,任务状态查询功能.
任务提交通过请求/响应模式进行,请求和查询命令格式均为单行命令:
[命令][空格][参数1][空格][参数2][…]\r\n(类推可以多个参数)

> 返回为多行格式:
> [响应号]\r\n
> [属性1][冒号][属性值1]\r\n
> […]\r\n
> [空行]\r\n

  1. 提交任务
> 命令:
> [PUT](PUT.md)[空格][$localpath][空格][$remotepath]\r\n
($localpath表示本地文件全路径, $remotepath远程文件相对路径)
> 响应:
> 300 表示成功
> 301 表示文件不存在
> 返回300时会有属性:[taskid](taskid.md)[:][$taskid]\r\n
($taskid表示为当前提交任务的任务号,任务号主要用于查询任务状态)
> 返回301表示提交的$localpath为不存在的文件

> 说明:所有通过命令传输路径必须进行urlencode,接收端进行urldecode.

> 2.任务状态查询
> 命令:
> [STATUS](STATUS.md)[空格][$taskid]\r\n
($taskid表示提交任务时候返回的任务号)
> 响应:
> 300 表示成功
> 303 不存在的任务号
> 返回300时表示查询任务状态成功,同时返回以下属性:
> [TASKID](TASKID.md)[:][$taskid]\r\n
> [STATUS](STATUS.md)[:][$status]\r\n
> [SPEED](SPEED.md)[:][$speed]\r\n
> [RETRY](RETRY.md)[:][$nretry]\r\n
> [TIMEOUT](TIMEOUT.md)[:][$timeout]\r\n
> (以上各行为任意顺序.
> > $taskid为任务号;
> > $status为状态0表示等待,1表示完成;
> > $speed为传输速度单位为bytes/second;
> > $retry为重试次数;
> > $timeout为超时次数)

> 返回303表示非法的任务号.

> 数据接收端服务程序
> 服务端开启TCP监听服务, 端口为, 目前支持的命令有:truncate, put, md5sum, del, 传输协议采用类似FTP和HTTP协议,命令格式为:
> [命令名称] [空格] [参数]\r\n
> [属性1][冒号][属性1值]\r\n
> [属性2][冒号][属性2值]\r\n
> …可以支持N个属性
> [空行]\r\n
> [数据]
(有数据发送需要在属性申明数据长度)
> 每次请求正常情况下都会有返回,
> 返回格式为:
> [响应号][空格][原因说明]\r\n
> [空行]\r\n

> 说明:中括号表示内表示一个独立的块,括号内为说明

> 命令详解
  1. 创建新文件
> 命令:
> [TRUNCATE](TRUNCATE.md)[空格][$path]\r\n
($path为相对于文件传输目录的相对目录)
> 属性:
> [SIZE](SIZE.md)[:][$size]\r\n
($size为创建文件的大小,不能为空)

> 2.传输文件
> 命令:
> [PUT](PUT.md)[空格][$path]\r\n
($path为文件相对路径全路径)
> 属性:
> [OFFSET](OFFSET.md)[:][$offset]\r\n
(文件偏移,主要用于多线程传输和断点续传,类似HTTP协议的Range)
> [SIZE](SIZE.md)[:][$size]\r\n
($size为传输数据的长度)

> 3.文件MD5校验
> 命令:
> [MD5SUM](MD5SUM.md)[空格][$path]\r\n
($path表示文件路径)
> 属性:
> [MD5](MD5.md)[:][$md5]\r\n
($md5为客户端计算的文件的MD5的16进制32位字符)


> 4.删除文件
> 命令:
> [DEL](DEL.md)[空格][$path]\r\n
($path为文件相对路径)
> 属性:空

> 5.响应返回汇总
> 200 OK\r\n\r\n
(命令成功执行)
> 201 not implement\r\n\r\n
(命令未实现)
> 203 bad requestment\r\n\r\n
(请求格式不规范)
> 205 service error\r\n\r\n
(服务端发错误,如磁盘满或者没有权限读写等)
> 207 file not exists\r\n\r\n
(文件不存在,针对删除文件和文件校验的响应)
> 209 invalid md5\r\n\r\n
(MD5对不上,针对文件MD5校验)


> 说明:所有通过命令传输路径必须进行urlencode,接收端进行urldecode.

> 系统流程
> 任务提交单元提交任务到本地传输单元;本地传输单元接收到任务放入任务队列同时进行编号,将任务号返回给提交单元;心跳激活状态下查询任务队列是否有等待状态下的任务,任务分块,取到文件接收端可用连接传输数据,数据传输完成后生成本地文件校验码对远程文件进行校验,成功后置任务状态为完成状态,否则从头传输该任务;接收端根据传输端命令执行命令(创建新文件.接收文件.校验文件).